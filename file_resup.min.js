/**
 * @file
 * Written by Henri MEDOT <henri.medot[AT]absyx[DOT]fr>
 * http://www.absyx.fr
 */

!function(e){"use strict";var a=0,i=function(e){if(1024>e)return Drupal.formatPlural(e,"1 byte","@count bytes");e/=1024;var a,i,t,l=[Drupal.t("@size KB"),Drupal.t("@size MB"),Drupal.t("@size GB")];for(i=0,t=l.length;t>i&&(a=Math.round(100*e)/100,1024<=a);i++)e/=1024;return l[i].replace("@size",a)},t=function(a){var i=2,t="";return e.each([86400,3600,60,1],function(e,l){if(a>=l){var n=Math.floor(a/l),r=0==e?Drupal.formatPlural(n,"1 day","@count days"):1==e?Drupal.formatPlural(n,"1 hour","@count hours"):2==e?Drupal.formatPlural(n,"1 min","@count min"):Drupal.formatPlural(n,"1 sec","@count sec");t+=(t?" ":"")+r,a%=l,i--}return i?void 0:!1}),t?t:Drupal.t("0 sec")},l=function(a,t){if(e(".file-list",t).remove(),a.files.length){var r=e('<ul class="file-list"></ul>');e.each(a.files,function(s,o){var u=e('<a href="#" class="remove"><span>(-)</span></a>').attr("title",Drupal.t("Remove file")).click(function(e){n(t.parent()),a.removeFile(o),l(a,t),e.preventDefault()});r.append(e("<li>"+Drupal.checkPlain(o.name)+" <strong>("+i(o.size)+")</strong></li>").prepend(u))}),t.prepend(r)}t.siblings(".button.browse").toggleClass("disabled",!o(a)),s(t.siblings(".button.upload"),a)},n=function(a){e(".file-upload-js-error",a).remove()},r=function(a,i){var t=e(".file-upload-js-error",a);if(t.length){var l=t.children("ul");l.length?l.append("<li>"+i+"</li>"):t.html("<ul><li>"+t.html()+"</li><li>"+i+"</li></ul>")}else a.prepend('<div class="messages error file-upload-js-error">'+i+"</div>")},s=function(e,a){var i=a.uploading;e.html("<span>"+Drupal.t(i?"Cancel":"Upload")+"</span>").toggleClass("cancel",i).toggleClass("disabled",!a.files.length)},o=function(e){var a=e.options.maxFiles;return!a||1==a||e.files.length<a},u=function(){return(new Date).getTime()};Drupal.behaviors.fileResup={attach:function(d,p){e(".file-resup",d).once("file-resup",function(){this.id="file-resup-"+a++;var d,f,c,m,h=e(this).val(""),g=h.closest(".file-resup-wrapper");if(!Resup.support)return h.attr("disabled","disabled"),void g.hide();var v=e('input[name="'+h.data("upload-name")+'"]').hide(),b=e('input[name="'+h.data("upload-button-name")+'"]').hide();Drupal.ajax[b.attr("id")].progress.type="none";var D=g.closest(".form-item");D.find(".description:first").html(h.data("description"));var w=h.data("max-files");if(1!=w){var x=D.find("label:first");e.trim(x.text())==Drupal.t("Add a new file")&&x.text(Drupal.t("Add new files"))}var z=e('<div class="item-list drop"><div class="drop-message">'+h.data("drop-message")+"</div></div>").bind("drop",function(e){o(k)&&n(g),e.preventDefault()}).appendTo(g),y=h.data("max-filesize"),P=h.data("extensions").split(","),k=new Resup(h.data("url"),{chunkSize:p.file_resup.chunk_size,maxFiles:w,maxFileSize:y,extensions:P,query:{form_build_id:e('input[name="form_build_id"]',this.form).val()},fileValidator:function(e){return e.name.length>240?void r(g,Drupal.t("File name %filename exceeds the 240 characters limit.",{"%filename":e.name})):!0},drop:z.get(0)}),F=e(k.input).addClass("element-invisible");e('<a href="#" class="button browse"><span>'+Drupal.t("Browse")+"</span></a>").click(function(e){o(k)&&(n(g),F.click()),e.preventDefault()}).appendTo(g).after(F);var j=e('<a href="#" class="button upload disabled"><span>'+Drupal.t("Upload")+"</span></a>").click(function(e){f||(k.uploading?(k.stop(),d.element.hide(),s(j,k)):k.files.length&&(n(g),d||(d=new Drupal.progressBar("ajax-progress-"+h.attr("id")),z.after(d.element)),d.setProgress(0,Drupal.t("Starting upload...")),d.element.show(),m=0,k.retry(),s(j,k))),e.preventDefault()}).appendTo(g);k.onresupaddedfileerror=function(e,a){r(g,"size"==a?e.size?Drupal.t("File %filename is %filesize, exceeding the maximum file size of %maxsize.",{"%filename":e.name,"%filesize":i(e.size),"%maxsize":i(y)}):Drupal.t("File %filename is empty. Empty files cannot be uploaded.",{"%filename":e.name}):Drupal.t("File %filename cannot be uploaded. Only files with the following extensions are allowed: %extensions.",{"%filename":e.name,"%extensions":P.join(", ")}))},k.onresupfilesadded=function(a,i){var t=e(".file-upload-js-error",g).length;i>1&&t&&r(g,Drupal.t("@count files in total were skipped.",{"@count":i})),a.length&&(l(k,z),k.uploading||t||!h.data("autostart")||j.click())},k.onresupprogress=function(){var e=k.getProgress();if(e){if(1>e){m||(c=Drupal.t("Uploading..."));var a,i=u();i-m>999&&(m=i,a=k.getTime(),a>-1&&(c=Drupal.t("Uploading... (@time remaining)",{"@time":t(a)})))}else c=Drupal.t("Completing upload...");d.setProgress((Math.round(1e3*e)/10).toFixed(1),c)}},k.onresupended=function(a){if(a.length){f=!0,j.addClass("disabled");var i=[];e.each(a,function(e,a){i.push(a.id)}),h.val(i.join(",")),v.attr("disabled","disabled"),b.mousedown()}else d.element.hide()},k.onresupfileerror=function(e){k.stop(),d.element.hide(),s(j,k),r(g,Drupal.t("An error occurred while uploading file %filename. Please click <em>Upload</em> to retry.",{"%filename":e.name}))},e(this.form).bind("submit."+this.id,function(e){return k.uploading||f?(alert(Drupal.t("Files are currently being uploaded. Please stand by...")),e.stopImmediatePropagation(),!1):void 0}),e(window).bind("beforeunload."+this.id,function(){k.stop()})})},detach:function(a,i,t){"unload"==t&&e(".file-resup",a).each(function(){var a="."+this.id;e(this.form).unbind(a),e(window).unbind(a)})}}}(jQuery);