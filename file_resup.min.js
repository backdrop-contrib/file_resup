/**
 * @file
 * Written by Henri MEDOT <henri.medot[AT]absyx[DOT]fr>
 * http://www.absyx.fr
 */

!function(e,i){"use strict";var n=0,t=function(e){if(1024>e)return i.formatPlural(e,"1 byte","@count bytes");e/=1024;var n,t,a,l=[i.t("@size KB"),i.t("@size MB"),i.t("@size GB")];for(t=0,a=l.length;a>t&&(n=Math.round(100*e)/100,1024<=n);t++)e/=1024;return l[t].replace("@size",n)},a=function(n,s){if(e(".file-list",s).remove(),n.files.length){var o=e('<ul class="file-list"></ul>');e.each(n.files,function(r,d){var u=e('<a href="#" class="remove"><span>(-)</span></a>').attr("title",i.t("Remove file")).click(function(e){l(s.parent()),n.removeFile(d),a(n,s),e.preventDefault()});o.append(e("<li>"+i.checkPlain(d.name)+" <strong>("+t(d.size)+")</strong></li>").prepend(u))}),s.prepend(o)}r(s.siblings(".button.upload"),n)},l=function(i){e(".file-upload-js-error",i).remove()},s=function(i,n){var t=e(".file-upload-js-error",i);if(t.length){var a=t.children("ul");a.length?a.append("<li>"+n+"</li>"):t.html("<ul><li>"+t.html()+"</li><li>"+n+"</li></ul>")}else i.prepend('<div class="messages error file-upload-js-error">'+n+"</div>")},r=function(e,n){var t=n.uploading;e.html("<span>"+i.t(t?"Cancel":"Upload")+"</span>").toggleClass("cancel",t).toggleClass("disabled",!n.files.length)};i.behaviors.fileResup={attach:function(o,d){e(".file-resup",o).once("file-resup",function(){this.id="file-resup-"+n++;var o,u,p=e(this).val(""),f=p.closest(".file-resup-wrapper");if(!Resup.support)return p.attr("disabled","disabled"),void f.hide();var c=e('input[name="'+p.data("upload-name")+'"]').hide(),m=e('input[name="'+p.data("upload-button-name")+'"]').hide();i.ajax[m.attr("id")].progress.type="none";var h=f.closest(".form-item");h.find(".description:first").html(p.data("description"));var g=p.data("max-files");if(1!=g){var v=h.find("label:first");e.trim(v.text())==i.t("Add a new file")&&v.text(i.t("Add new files"))}var b=e('<div class="item-list drop"><div class="drop-message">'+p.data("drop-message")+"</div></div>").bind("drop",function(e){l(f),e.preventDefault()}).appendTo(f),x=p.data("max-filesize"),w=p.data("extensions").split(","),z=new Resup(p.data("url"),{chunkSize:d.file_resup.chunk_size,maxFiles:g,maxFileSize:x,extensions:w,query:{form_build_id:e('input[name="form_build_id"]',this.form).val()},fileValidator:function(e){return e.name.length>240?void s(f,i.t("File name %filename exceeds the 240 characters limit.",{"%filename":e.name})):!0},drop:b.get(0)}),y=e(z.input).addClass("element-invisible");e('<a href="#" class="button browse"><span>'+i.t("Browse")+"</span></a>").click(function(e){l(f),y.click(),e.preventDefault()}).appendTo(f).after(y);var j=e('<a href="#" class="button upload disabled"><span>'+i.t("Upload")+"</span></a>").click(function(e){u||(z.uploading?(z.stop(),o.element.hide(),r(j,z)):z.files.length&&(l(f),o||(o=new i.progressBar("ajax-progress-"+p.attr("id")),b.after(o.element)),o.setProgress(0,i.t("Starting upload...")),o.element.show(),z.retry(),r(j,z))),e.preventDefault()}).appendTo(f);z.onresupaddedfileerror=function(e,n){s(f,"size"==n?i.t("File %filename is %filesize, exceeding the maximum file size of %maxsize.",{"%filename":e.name,"%filesize":t(e.size),"%maxsize":t(x)}):i.t("File %filename cannot be uploaded. Only files with the following extensions are allowed: %extensions.",{"%filename":e.name,"%extensions":w.join(", ")}))},z.onresupfilesadded=function(n,t){t>1&&e(".file-upload-js-error",f).length&&s(f,i.t("@count files in total were skipped.",{"@count":t})),n.length&&a(z,b)},z.onresupprogress=function(){var e=z.getProgress(),n=i.t(1>e?"Uploading...":"Completing upload...");o.setProgress((Math.round(1e3*e)/10).toFixed(1),n)},z.onresupended=function(i){if(i.length){u=!0,j.addClass("disabled");var n=[];e.each(i,function(e,i){n.push(i.id)}),p.val(n.join(",")),c.attr("disabled","disabled"),m.mousedown()}else o.element.hide()},z.onresupfileerror=function(e){z.stop(),o.element.hide(),r(j,z),s(f,i.t("An error occurred while uploading file %filename. Please click <em>Upload</em> to retry.",{"%filename":e.name}))},e(this.form).bind("submit."+this.id,function(e){return z.uploading||u?(alert(i.t("Files are currently being uploaded. Please stand by...")),e.stopImmediatePropagation(),!1):void 0}),e(window).bind("beforeunload."+this.id,function(){z.stop()})})},detach:function(i,n,t){"unload"==t&&e(".file-resup",i).each(function(){var i="."+this.id;e(this.form).unbind(i),e(window).unbind(i)})}}}(jQuery,Drupal);