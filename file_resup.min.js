/**
 * @file
 * Written by Henri MEDOT <henri.medot[AT]absyx[DOT]fr>
 * http://www.absyx.fr
 */

!function(e,i){"use strict";var n=0,t=function(e){if(1024>e)return i.formatPlural(e,"1 byte","@count bytes");e/=1024;var n,t,a,l=[i.t("@size KB"),i.t("@size MB"),i.t("@size GB")];for(t=0,a=l.length;a>t&&(n=Math.round(100*e)/100,1024<=n);t++)e/=1024;return l[t].replace("@size",n)},a=function(n,s){if(e(".file-list",s).remove(),n.files.length){var d=e('<ul class="file-list"></ul>');e.each(n.files,function(r,o){var u=e('<a href="#" class="remove"><span>(-)</span></a>').attr("title",i.t("Remove file")).click(function(e){l(s.parent()),n.removeFile(o),a(n,s),e.preventDefault()});d.append(e("<li>"+i.checkPlain(o.name)+" <strong>("+t(o.size)+")</strong></li>").prepend(u))}),s.prepend(d)}s.siblings(".button.browse").toggleClass("disabled",!o(n)),r(s.siblings(".button.upload"),n)},l=function(i){e(".file-upload-js-error",i).remove()},s=function(i,n){var t=e(".file-upload-js-error",i);if(t.length){var a=t.children("ul");a.length?a.append("<li>"+n+"</li>"):t.html("<ul><li>"+t.html()+"</li><li>"+n+"</li></ul>")}else i.prepend('<div class="messages error file-upload-js-error">'+n+"</div>")},r=function(e,n){var t=n.uploading;e.html("<span>"+i.t(t?"Cancel":"Upload")+"</span>").toggleClass("cancel",t).toggleClass("disabled",!n.files.length)},o=function(e){var i=e.options.maxFiles;return!i||1==i||e.files.length<i};i.behaviors.fileResup={attach:function(d,u){e(".file-resup",d).once("file-resup",function(){this.id="file-resup-"+n++;var d,f,p=e(this).val(""),c=p.closest(".file-resup-wrapper");if(!Resup.support)return p.attr("disabled","disabled"),void c.hide();var m=e('input[name="'+p.data("upload-name")+'"]').hide(),h=e('input[name="'+p.data("upload-button-name")+'"]').hide();i.ajax[h.attr("id")].progress.type="none";var g=c.closest(".form-item");g.find(".description:first").html(p.data("description"));var v=p.data("max-files");if(1!=v){var b=g.find("label:first");e.trim(b.text())==i.t("Add a new file")&&b.text(i.t("Add new files"))}var x=e('<div class="item-list drop"><div class="drop-message">'+p.data("drop-message")+"</div></div>").bind("drop",function(e){o(y)&&l(c),e.preventDefault()}).appendTo(c),w=p.data("max-filesize"),z=p.data("extensions").split(","),y=new Resup(p.data("url"),{chunkSize:u.file_resup.chunk_size,maxFiles:v,maxFileSize:w,extensions:z,query:{form_build_id:e('input[name="form_build_id"]',this.form).val()},fileValidator:function(e){return e.name.length>240?void s(c,i.t("File name %filename exceeds the 240 characters limit.",{"%filename":e.name})):!0},drop:x.get(0)}),F=e(y.input).addClass("element-invisible");e('<a href="#" class="button browse"><span>'+i.t("Browse")+"</span></a>").click(function(e){o(y)&&(l(c),F.click()),e.preventDefault()}).appendTo(c).after(F);var j=e('<a href="#" class="button upload disabled"><span>'+i.t("Upload")+"</span></a>").click(function(e){f||(y.uploading?(y.stop(),d.element.hide(),r(j,y)):y.files.length&&(l(c),d||(d=new i.progressBar("ajax-progress-"+p.attr("id")),x.after(d.element)),d.setProgress(0,i.t("Starting upload...")),d.element.show(),y.retry(),r(j,y))),e.preventDefault()}).appendTo(c);y.onresupaddedfileerror=function(e,n){s(c,"size"==n?e.size?i.t("File %filename is %filesize, exceeding the maximum file size of %maxsize.",{"%filename":e.name,"%filesize":t(e.size),"%maxsize":t(w)}):i.t("File %filename is empty. Empty files cannot be uploaded.",{"%filename":e.name}):i.t("File %filename cannot be uploaded. Only files with the following extensions are allowed: %extensions.",{"%filename":e.name,"%extensions":z.join(", ")}))},y.onresupfilesadded=function(n,t){t>1&&e(".file-upload-js-error",c).length&&s(c,i.t("@count files in total were skipped.",{"@count":t})),n.length&&a(y,x)},y.onresupprogress=function(){var e=y.getProgress(),n=i.t(1>e?"Uploading...":"Completing upload...");d.setProgress((Math.round(1e3*e)/10).toFixed(1),n)},y.onresupended=function(i){if(i.length){f=!0,j.addClass("disabled");var n=[];e.each(i,function(e,i){n.push(i.id)}),p.val(n.join(",")),m.attr("disabled","disabled"),h.mousedown()}else d.element.hide()},y.onresupfileerror=function(e){y.stop(),d.element.hide(),r(j,y),s(c,i.t("An error occurred while uploading file %filename. Please click <em>Upload</em> to retry.",{"%filename":e.name}))},e(this.form).bind("submit."+this.id,function(e){return y.uploading||f?(alert(i.t("Files are currently being uploaded. Please stand by...")),e.stopImmediatePropagation(),!1):void 0}),e(window).bind("beforeunload."+this.id,function(){y.stop()})})},detach:function(i,n,t){"unload"==t&&e(".file-resup",i).each(function(){var i="."+this.id;e(this.form).unbind(i),e(window).unbind(i)})}}}(jQuery,Drupal);