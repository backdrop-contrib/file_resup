/**
 * @file
 * Written by Henri MEDOT <henri.medot[AT]absyx[DOT]fr>
 * http://www.absyx.fr
 */

!function(e,i){"use strict";var n=0,t=function(e){if(1024>e)return i.formatPlural(e,"1 byte","@count bytes");e/=1024;var n,t,a,l=[i.t("@size KB"),i.t("@size MB"),i.t("@size GB")];for(t=0,a=l.length;a>t&&(n=Math.round(100*e)/100,1024<=n);t++)e/=1024;return l[t].replace("@size",n)},a=function(n){var t=2,a="";return e.each([86400,3600,60,1],function(e,l){if(n>=l){var s=Math.floor(n/l),r=0==e?i.formatPlural(s,"1 day","@count days"):1==e?i.formatPlural(s,"1 hour","@count hours"):2==e?i.formatPlural(s,"1 min","@count min"):i.formatPlural(s,"1 sec","@count sec");a+=(a?" ":"")+r,n%=l,t--}return t?void 0:!1}),a?a:i.t("0 sec")},l=function(n,a){if(e(".file-list",a).remove(),n.files.length){var r=e('<ul class="file-list"></ul>');e.each(n.files,function(o,d){var u=e('<a href="#" class="remove"><span>(-)</span></a>').attr("title",i.t("Remove file")).click(function(e){s(a.parent()),n.removeFile(d),l(n,a),e.preventDefault()});r.append(e("<li>"+i.checkPlain(d.name)+" <strong>("+t(d.size)+")</strong></li>").prepend(u))}),a.prepend(r)}a.siblings(".button.browse").toggleClass("disabled",!d(n)),o(a.siblings(".button.upload"),n)},s=function(i){e(".file-upload-js-error",i).remove()},r=function(i,n){var t=e(".file-upload-js-error",i);if(t.length){var a=t.children("ul");a.length?a.append("<li>"+n+"</li>"):t.html("<ul><li>"+t.html()+"</li><li>"+n+"</li></ul>")}else i.prepend('<div class="messages error file-upload-js-error">'+n+"</div>")},o=function(e,n){var t=n.uploading;e.html("<span>"+i.t(t?"Cancel":"Upload")+"</span>").toggleClass("cancel",t).toggleClass("disabled",!n.files.length)},d=function(e){var i=e.options.maxFiles;return!i||1==i||e.files.length<i},u=function(){return(new Date).getTime()};i.behaviors.fileResup={attach:function(f,p){e(".file-resup",f).once("file-resup",function(){this.id="file-resup-"+n++;var f,c,m,h,g,v,b=e(this).val(""),w=b.closest(".file-resup-wrapper");if(!Resup.support)return b.attr("disabled","disabled"),void w.hide();var x=e('input[name="'+b.data("upload-name")+'"]').hide(),z=e('input[name="'+b.data("upload-button-name")+'"]').hide();i.ajax[z.attr("id")].progress.type="none";var y=w.closest(".form-item");y.find(".description:first").html(b.data("description"));var P=b.data("max-files");if(1!=P){var k=y.find("label:first");e.trim(k.text())==i.t("Add a new file")&&k.text(i.t("Add new files"))}var F=e('<div class="item-list drop"><div class="drop-message">'+b.data("drop-message")+"</div></div>").bind("drop",function(e){d(D)&&s(w),e.preventDefault()}).appendTo(w),j=b.data("max-filesize"),C=b.data("extensions").split(","),D=new Resup(b.data("url"),{chunkSize:p.file_resup.chunk_size,maxFiles:P,maxFileSize:j,extensions:C,query:{form_build_id:e('input[name="form_build_id"]',this.form).val()},fileValidator:function(e){return e.name.length>240?void r(w,i.t("File name %filename exceeds the 240 characters limit.",{"%filename":e.name})):!0},drop:F.get(0)}),_=e(D.input).addClass("element-invisible");e('<a href="#" class="button browse"><span>'+i.t("Browse")+"</span></a>").click(function(e){d(D)&&(s(w),_.click()),e.preventDefault()}).appendTo(w).after(_);var B=e('<a href="#" class="button upload disabled"><span>'+i.t("Upload")+"</span></a>").click(function(e){c||(D.uploading?(D.stop(),f.element.hide(),o(B,D)):D.files.length&&(s(w),f||(f=new i.progressBar("ajax-progress-"+b.attr("id")),F.after(f.element)),m=0,g=i.t("Uploading..."),f.setProgress(0,g),f.element.show(),D.retry(),o(B,D))),e.preventDefault()}).appendTo(w);D.onresupaddedfileerror=function(e,n){r(w,"size"==n?e.size?i.t("File %filename is %filesize, exceeding the maximum file size of %maxsize.",{"%filename":e.name,"%filesize":t(e.size),"%maxsize":t(j)}):i.t("File %filename is empty. Empty files cannot be uploaded.",{"%filename":e.name}):i.t("File %filename cannot be uploaded. Only files with the following extensions are allowed: %extensions.",{"%filename":e.name,"%extensions":C.join(", ")}))},D.onresupfilesadded=function(n,t){var a=e(".file-upload-js-error",w).length;t>1&&a&&r(w,i.t("@count files in total were skipped.",{"@count":t})),n.length&&(l(D,F),D.uploading||a||!b.data("autostart")||B.click())},D.onresupprogress=function(){var e=D.getProgress();if(e){if(m)if(1>e){var n=u();if(n-v>999&&e>m){v=n;var t=(n-h)*(1-e)/(e-m);g=i.t("Uploading... (@time remaining)",{"@time":a(Math.round(t/1e3))})}}else g=i.t("Completing upload...");else h=v=u(),m=e;f.setProgress((Math.round(1e3*e)/10).toFixed(1),g)}},D.onresupended=function(i){if(i.length){c=!0,B.addClass("disabled");var n=[];e.each(i,function(e,i){n.push(i.id)}),b.val(n.join(",")),x.attr("disabled","disabled"),z.mousedown()}else f.element.hide()},D.onresupfileerror=function(e){D.stop(),f.element.hide(),o(B,D),r(w,i.t("An error occurred while uploading file %filename. Please click <em>Upload</em> to retry.",{"%filename":e.name}))},e(this.form).bind("submit."+this.id,function(e){return D.uploading||c?(alert(i.t("Files are currently being uploaded. Please stand by...")),e.stopImmediatePropagation(),!1):void 0}),e(window).bind("beforeunload."+this.id,function(){D.stop()})})},detach:function(i,n,t){"unload"==t&&e(".file-resup",i).each(function(){var i="."+this.id;e(this.form).unbind(i),e(window).unbind(i)})}}}(jQuery,Drupal);