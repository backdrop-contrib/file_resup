/**
 * @file
 * Written by Henri MEDOT <henri.medot[AT]absyx[DOT]fr>
 * http://www.absyx.fr
 */

!function(e,t){"use strict";var i=0,n=function(e){if(1024>e)return t.formatPlural(e,"1 byte","@count bytes");e/=1024;var i,n,a,r=[t.t("@size KB"),t.t("@size MB"),t.t("@size GB")];for(n=0,a=r.length;a>n&&(i=Math.round(100*e)/100,1024<=i);n++)e/=1024;return r[n].replace("@size",i)},a=function(i){var n=2,a="";return e.each([86400,3600,60,1],function(e,r){if(i>=r){var s=Math.floor(i/r),o=0==e?t.formatPlural(s,"1 day","@count days"):1==e?t.formatPlural(s,"1 hour","@count hours"):2==e?t.formatPlural(s,"1 min","@count min"):t.formatPlural(s,"1 sec","@count sec");a+=(a?" ":"")+o,i%=r,n--}return n?void 0:!1}),a?a:t.t("0 sec")},r=function(i,a){if(e(".file-list",a).remove(),i.files.length){var o=e('<ul class="file-list"></ul>');e.each(i.files,function(l,u){var f=e('<a href="#" class="remove"><span>(-)</span></a>').attr("title",t.t("Remove file")).click(function(e){s(a.parent()),i.removeFile(u),r(i,a),e.preventDefault()});o.append(e("<li>"+t.checkPlain(u.name)+" <strong>("+n(u.size)+")</strong></li>").prepend(f))}),a.prepend(o)}a.siblings(".button.browse").toggleClass("disabled",!u(i)),l(a.siblings(".button.upload"),i)},s=function(t){e(".file-upload-js-error",t).remove()},o=function(t,i){var n=e(".file-upload-js-error",t);if(n.length){var a=n.children("ul");a.length?a.append("<li>"+i+"</li>"):n.html("<ul><li>"+n.html()+"</li><li>"+i+"</li></ul>")}else t.prepend('<div class="messages error file-upload-js-error">'+i+"</div>")},l=function(e,i){var n=i.uploading;e.html("<span>"+t.t(n?"Cancel":"Upload")+"</span>").toggleClass("cancel",n).toggleClass("disabled",!i.files.length)},u=function(e){var t=e.options.maxFiles;return!t||1==t||e.files.length<t},f=function(){return(new Date).getTime()};t.behaviors.fileResup={attach:function(d,p){e(".file-resup",d).once("file-resup",function(){this.id="file-resup-"+i++;var d,c,h,m,v=e(this).val(""),g=v.closest(".file-resup-wrapper");if(!Resup.support)return v.attr("disabled","disabled"),void g.hide();var x=e('input[name="'+v.data("upload-name")+'"]').hide(),b=e('input[name="'+v.data("upload-button-name")+'"]').hide();t.ajax[b.attr("id")].progress.type="none";var z=g.closest(".form-item");z.find(".description:first").html(v.data("description"));var w=v.data("max-files");if(1!=w){var k=z.find("label:first");e.trim(k.text())==t.t("Add a new file")&&k.text(t.t("Add new files"))}var y=e('<div class="item-list drop"><div class="drop-message">'+v.data("drop-message")+"</div></div>").bind("drop",function(e){u(_)&&s(g),e.preventDefault()}).appendTo(g),C=v.data("max-filesize"),F=v.data("extensions").split(","),_=new Resup(v.data("url"),{chunkSize:p.file_resup.chunk_size,maxFiles:w,maxFileSize:C,extensions:F,query:{form_build_id:e('input[name="form_build_id"]',this.form).val()},fileValidator:function(e){return e.name.length>240?void o(g,t.t("File name %filename exceeds the 240 characters limit.",{"%filename":e.name})):!0},drop:y.get(0)}),P=e(_.input).addClass("element-invisible");e('<a href="#" class="button browse"><span>'+t.t("Browse")+"</span></a>").click(function(e){u(_)&&(s(g),P.click()),e.preventDefault()}).appendTo(g).after(P);var S=e('<a href="#" class="button upload disabled"><span>'+t.t("Upload")+"</span></a>").click(function(e){c||(_.uploading?(_.stop(),d.element.hide(),l(S,_)):_.files.length&&(s(g),d||(d=new t.progressBar("ajax-progress-"+v.attr("id")),y.after(d.element)),d.setProgress(0,t.t("Starting upload...")),d.element.show(),m=0,_.retry(),l(S,_))),e.preventDefault()}).appendTo(g);_.onresupaddedfileerror=function(e,i){o(g,"size"==i?e.size?t.t("File %filename is %filesize, exceeding the maximum file size of %maxsize.",{"%filename":e.name,"%filesize":n(e.size),"%maxsize":n(C)}):t.t("File %filename is empty. Empty files cannot be uploaded.",{"%filename":e.name}):t.t("File %filename cannot be uploaded. Only files with the following extensions are allowed: %extensions.",{"%filename":e.name,"%extensions":F.join(", ")}))},_.onresupfilesadded=function(i,n){var a=e(".file-upload-js-error",g).length;n>1&&a&&o(g,t.t("@count files in total were skipped.",{"@count":n})),i.length&&(r(_,y),_.uploading||a||!v.data("autostart")||S.click())},_.onresupprogress=function(){var e=_.getProgress();if(e){if(1>e){m||(h=t.t("Uploading..."));var i,n=f();n-m>999&&(m=n,i=_.getTime(),i>-1&&(h=t.t("Uploading... (@time remaining)",{"@time":a(i)})))}else h=t.t("Completing upload...");d.setProgress((Math.round(1e3*e)/10).toFixed(1),h)}},_.onresupended=function(t){if(t.length){c=!0,S.addClass("disabled");var i=[];e.each(t,function(e,t){i.push(t.id)}),v.val(i.join(",")),x.attr("disabled","disabled"),b.mousedown()}else d.element.hide()},_.onresupfileerror=function(e){_.stop(),d.element.hide(),l(S,_),o(g,t.t("An error occurred while uploading file %filename. Please click <em>Upload</em> to retry.",{"%filename":e.name}))},e(this.form).bind("submit."+this.id,function(e){return _.uploading||c?(alert(t.t("Files are currently being uploaded. Please stand by...")),e.stopImmediatePropagation(),!1):void 0}),e(window).bind("beforeunload."+this.id,function(){_.stop()})})},detach:function(t,i,n){"unload"==n&&e(".file-resup",t).each(function(){var t="."+this.id;e(this.form).unbind(t),e(window).unbind(t)})}}}(jQuery,Drupal);